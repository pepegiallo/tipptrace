{% extends "base.html" %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">{{ game.name }}</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('games.edit', game_id=game.id) }}">Tippspiel bearbeiten</a>
      <a class="btn btn-outline-primary" href="{{ url_for('games.config', game_id=game.id) }}">Konfiguration</a>
      <a class="btn btn-primary" href="{{ url_for('games.evaluation', game_id=game.id) }}">Auswertung</a>
      <form action="{{ url_for('games.delete', game_id=game.id) }}" method="post" class="d-inline" onsubmit="return confirm('Dieses Tippspiel wirklich löschen?');">
        <button class="btn btn-outline-danger">Löschen</button>
      </form>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Einsatz / Person</div>
          <div class="fs-5">{{ game.stake_per_person | money }} €</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Mitglieder</div>
          <div class="fs-5">{{ game.members|length }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Gesamteinsatz</div>
          <div class="fs-5">{{ game.total_stake | money }} €</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">URL</div>
          {% if game.url %}
            <a href="{{ game.url }}" target="_blank" rel="noopener">{{ game.url }}</a>
          {% else %}
            <span>-</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if game.config %}
  <div class="card mb-4">
    <div class="card-header">Konfiguration (Kurzüberblick)</div>
    <div class="card-body row">
      <div class="col-md-4">
        <div class="text-muted small">Anteil Siege</div>
        <div class="fs-6">{{ game.config.victory_share_percent }} % ({{ (game.total_stake * game.config.victory_share_percent / 100) | money }} €)</div>
        <div class="text-muted small mt-2">Anteil Platzierung</div>
        <div class="fs-6">{{ game.config.placement_share_percent }} % ({{ (game.total_stake * game.config.placement_share_percent / 100) | money }} €)</div>
      </div>
      <div class="col-md-4">
        <div class="text-muted small">Spieltage</div>
        <div class="fs-6">{{ game.config.num_matchdays }}</div>
        <div class="text-muted small mt-2">Ausschüttung je Spieltag</div>
        {% set victory_pot = (game.total_stake * game.config.victory_share_percent / 100) %}
        <div class="fs-6">{{ (victory_pot / (game.config.num_matchdays if game.config.num_matchdays else 1)) | money }} €</div>
      </div>
      <div class="col-md-4">
        <div class="text-muted small">Platzierungs-Prozente</div>
        {% if game.placement_payouts %}
          <ul class="mb-0">
            {% for r in game.placement_payouts %}
              <li>Platz {{ r.rank }}: {{ r.percent }} %</li>
            {% endfor %}
          </ul>
        {% else %}
          <div>-</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="h5 mb-0">Mitglieder</h2>
    <a class="btn btn-primary" href="{{ url_for('members.create', game_id=game.id) }}">Neues Mitglied</a>
  </div>

  {% if game.members %}
  <div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
              <th>Name</th>
              <th>Nickname</th>
              <th>E-Mail</th>
              <th>Zahlungsart</th>
              <th>Referenz</th>
              <th class="d-none d-lg-table-cell">Letzte Siege</th>
              <th class="d-none d-lg-table-cell">Letzte Punkte</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>
          {% for m in game.members %}
            <tr>
              <td>{{ m.first_name }} {{ m.last_name }}</td>
              <td>{{ m.nickname or '-' }}</td>
              <td><a href="mailto:{{ m.email }}">{{ m.email }}</a></td>
              <td>{{ m.payment_method.label if m.payment_method else '-' }}</td>
              <td>{{ m.payment_method.reference if m.payment_method and m.payment_method.reference else '-' }}</td>
          
              <!-- ab lg sichtbar -->
              <td class="d-none d-lg-table-cell">
                {% if m.latest_victory %}
                  {{ m.latest_victory.victories }} <span class="text-muted">({{ m.latest_victory.date.isoformat() }})</span>
                {% else %}-{% endif %}
              </td>
              <td class="d-none d-lg-table-cell">
                {% if m.latest_points %}
                  {{ m.latest_points.points }} <span class="text-muted">({{ m.latest_points.date.isoformat() }})</span>
                {% else %}-{% endif %}
              </td>
          
              <td class="text-nowrap">
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('members.edit', member_id=m.id) }}">Bearbeiten</a>
                <form action="{{ url_for('members.delete', member_id=m.id) }}" method="post" class="d-inline" onsubmit="return confirm('Dieses Mitglied wirklich löschen?');">
                  <button class="btn btn-sm btn-outline-danger">Löschen</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          </tbody>
          
    </table>
  </div>
  {% else %}
    <p>Keine Mitglieder vorhanden.</p>
  {% endif %}
{% endblock %}
